# GitHub Actions workflow لبناء APK غير موقع لتطبيق React (TypeScript)
# ضع هذا الملف في: .github/workflows/build-apk-unsigned.yml
# تشغيل يدوي: Actions -> Build Android APK (Unsigned) -> Run workflow
on:
  workflow_dispatch:
    inputs:
      web_dir:
        description: 'مجلد ناتج البناء (لتطبيق: build أو dist)'
        required: false
        default: 'build'

jobs:
  build_apk_unsigned:
    name: Build unsigned Android APK (React + Capacitor)
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build web assets
        run: |
          # غيّر الأمر إذا تستخدم yarn أو أمر مخصص
          npm run build --if-present
          echo "Web build dir: ${{ github.event.inputs.web_dir }}"
          ls -la "${{ github.event.inputs.web_dir }}" || true

      - name: Install Capacitor CLI & core
        run: |
          npm install --no-save @capacitor/cli @capacitor/core

      - name: Ensure capacitor.config.json exists (set webDir)
        run: |
          WEBDIR="${{ github.event.inputs.web_dir }}"
          if [ -f capacitor.config.json ]; then
            echo "capacitor.config.json exists; updating webDir to $WEBDIR"
            node -e "const fs=require('fs'); const c=require('./capacitor.config.json'); c.webDir='$WEBDIR'; fs.writeFileSync('capacitor.config.json', JSON.stringify(c, null, 2));"
            cat capacitor.config.json
          else
            echo "Creating capacitor.config.json with webDir=$WEBDIR"
            cat > capacitor.config.json <<EOF
          {
            "appId": "com.example.app",
            "appName": "ReactApp",
            "webDir": "$WEBDIR",
            "bundledWebRuntime": false
          }
          EOF
            cat capacitor.config.json
          fi

      - name: Ensure Android platform exists and copy web assets
        run: |
          if [ -d "android" ]; then
            echo "android platform already exists"
          else
            npx cap add android || true
          fi
          npx cap copy android --build || true

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 33
          build-tools: 33.0.2

      - name: Build APKs (unsigned)
        working-directory: android
        run: |
          chmod +x ./gradlew || true
          if [ ! -f ./gradlew ]; then
            echo "gradlew not found in android/. تأكد أن منصة Android متاحة."
            exit 1
          fi
          # سنبني debug و release (release سيكون بدون توقيع - unsigned)
          ./gradlew clean assembleDebug assembleRelease || true
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx1536m"

      - name: List generated APK/AAB files
        working-directory: android
        run: |
          echo "Generated artifacts:"
          find . -type f -name "*.apk" -o -name "*.aab" -maxdepth 8 || true

      - name: Upload APK/AAB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-unsigned-artifacts
          path: |
            android/app/build/outputs/**/*.apk
            android/app/build/outputs/**/*.aab
