# âš™ï¸ Build Unsigned Android APK (React + Capacitor)
# Ù…Ù„Ù: .github/workflows/build-apk-unsigned.yml

name: Build Android APK (Unsigned)

on:
  workflow_dispatch:
    inputs:
      web_dir:
        description: 'Ù…Ø¬Ù„Ø¯ Ù†Ø§ØªØ¬ Ø§Ù„Ø¨Ù†Ø§Ø¡ (build Ø£Ùˆ dist)'
        required: false
        default: 'build'

jobs:
  build_apk_unsigned:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ðŸ’¾ Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ðŸ“¦ Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: ðŸ§± Build web assets
        run: |
          echo "ðŸ“¦ Building web assets..."
          npm run build --if-present
          echo "Web build dir: ${{ github.event.inputs.web_dir }}"
          ls -la "${{ github.event.inputs.web_dir }}" || true

      - name: âš¡ Install Capacitor core + Android
        run: |
          npm install --no-save @capacitor/core @capacitor/cli @capacitor/android

      - name: ðŸ§© Create capacitor.config.json
        run: |
          WEBDIR="${{ github.event.inputs.web_dir }}"
          cat > capacitor.config.json <<EOF
          {
            "appId": "com.example.app",
            "appName": "ReactApp",
            "webDir": "$WEBDIR"
          }
          EOF
          cat capacitor.config.json

      - name: ðŸ§° Rebuild Android platform (force)
        run: |
          rm -rf android
          echo "ðŸ§± Rebuilding Android platform..."
          npx cap add android
          npx cap doctor
          ls -la android || true
          echo "âœ… Android platform rebuilt."

      - name: ðŸ”„ Sync Capacitor
        run: |
          npx cap sync android
          ls -la android || true
          if [ ! -f "android/capacitor.settings.gradle" ]; then
            echo "âŒ capacitor.settings.gradle missing. Android platform creation failed."
            exit 1
          fi
          echo "âœ… capacitor.settings.gradle exists."

      - name: â˜• Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ¤– Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ—ï¸ Build unsigned APKs
        working-directory: android
        run: |
          chmod +x ./gradlew || true
          echo "ðŸš€ Building APKs (debug & release)..."
          ./gradlew clean assembleDebug assembleRelease
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g"

      - name: ðŸ“‹ List generated APKs
        working-directory: android
        run: |
          echo "Generated APKs:"
          find . -type f \( -name "*.apk" -o -name "*.aab" \) -print || echo "âš ï¸ No APKs found."

      - name: ðŸ“¤ Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-unsigned-apks
          path: |
            android/app/build/outputs/**/*.apk
            android/app/build/outputs/**/*.aab
