# ðŸ“± Build Unsigned Android APK (React + Capacitor)
# Ø¶Ø¹ Ø§Ù„Ù…Ù„Ù ÙÙŠ: .github/workflows/build-apk-unsigned.yml
# Ù„ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ: Actions â†’ Build Android APK (Unsigned) â†’ Run workflow

name: Build Android APK (Unsigned)

on:
  workflow_dispatch:
    inputs:
      web_dir:
        description: 'Ù…Ø¬Ù„Ø¯ Ù†Ø§ØªØ¬ Ø§Ù„Ø¨Ù†Ø§Ø¡ (build Ø£Ùˆ dist)'
        required: false
        default: 'build'

jobs:
  build_apk_unsigned:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build web assets
        run: |
          npm run build --if-present
          echo "Web build dir: ${{ github.event.inputs.web_dir }}"
          ls -la "${{ github.event.inputs.web_dir }}" || true

      - name: Install Capacitor CLI & Android
        run: |
          npm install --no-save @capacitor/cli @capacitor/core @capacitor/android

      - name: Create or update capacitor.config.json
        run: |
          WEBDIR="${{ github.event.inputs.web_dir }}"
          if [ -f capacitor.config.json ]; then
            node -e "const fs=require('fs');let c=require('./capacitor.config.json');c.webDir='$WEBDIR';delete c.bundledWebRuntime;fs.writeFileSync('capacitor.config.json', JSON.stringify(c,null,2));"
          else
            echo "Creating capacitor.config.json..."
            cat > capacitor.config.json <<EOF
          {
            "appId": "com.example.app",
            "appName": "ReactApp",
            "webDir": "$WEBDIR"
          }
          EOF
          fi
          cat capacitor.config.json

      - name: Ensure Android platform exists
        run: |
          if [ ! -d android ]; then
            echo "âš™ï¸ Adding Android platform..."
            npx cap add android
          else
            echo "âœ… Android platform already exists."
          fi

      - name: Copy web assets
        run: npx cap copy android --build

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK (latest)
        uses: android-actions/setup-android@v3

      - name: Build unsigned APKs
        working-directory: android
        run: |
          chmod +x ./gradlew || true
          ./gradlew clean assembleDebug assembleRelease
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g"

      - name: List generated APKs
        working-directory: android
        run: find . -type f \( -name "*.apk" -o -name "*.aab" \) -print

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-unsigned-apks
          path: |
            android/app/build/outputs/**/*.apk
            android/app/build/outputs/**/*.aab
