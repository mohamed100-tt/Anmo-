# GitHub Actions workflow Ù„Ø¨Ù†Ø§Ø¡ APK ØºÙŠØ± Ù…ÙˆÙ‚Ø¹ Ù„ØªØ·Ø¨ÙŠÙ‚ React (TypeScript)
# Ø§Ù„Ù…Ù„Ù: .github/workflows/build-apk-unsigned.yml
# Ø§Ù„ØªØ´ØºÙŠÙ„: Actions -> Build Android APK (Unsigned) -> Run workflow
# Ø§Ù„Ù…Ø·ÙˆØ±: Lucifer
# Ø§Ù„ØªØ§Ø±ÙŠØ®: 12 Ù†ÙˆÙÙ…Ø¨Ø± 2025
# Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
# - ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ProGuard/R8 (minifyEnabled) Ù…ÙØ¹Ø¯Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø¥ØµØ¯Ø§Ø± release [[1]].
# - ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© ØªØ¨Ø¹ÙŠØ§Øª Capacitor Plugin Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ù†Ø§Ø¡ [[7]].
# - Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø¹ ØªÙ‡ÙŠØ¦Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù€ .env Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ [[25]].

name: Ø¨Ù†Ø§Ø¡ APK ØºÙŠØ± Ù…ÙˆÙ‚Ø¹ (React + Capacitor)

on:
  workflow_dispatch:
    inputs:
      web_dir:
        description: 'Ù…Ø¬Ù„Ø¯ Ù†Ø§ØªØ¬ Ø§Ù„Ø¨Ù†Ø§Ø¡ (Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª React Ø¹Ø§Ø¯Ø©: build Ø£Ùˆ dist)'
        required: false
        default: 'build'
        type: string
      build_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡ (debug Ø£Ùˆ release Ø£Ùˆ both)'
        required: false
        default: 'release'
        type: choice
        options:
          - debug
          - release
          - both

jobs:
  build_apk_unsigned:
    name: Ø¨Ù†Ø§Ø¡ APK (React + Capacitor)
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      JAVA_OPTS: '-Xmx2048m'

    steps:
      - name: ðŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v4

      - name: âš™ï¸ ØªÙ‡ÙŠØ¦Ø© Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm' # ØªØ­Ø³ÙŠÙ†: Ø§Ø³ØªØ®Ø¯Ø§Ù… cache ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù€ npm [[11]]

      - name: ðŸ“¦ ØªØ«Ø¨ÙŠØª ØªØ¨Ø¹ÙŠØ§Øª npm
        run: |
          if [ -f package-lock.json ]; then
            echo "Ø§Ø³ØªØ®Ø¯Ø§Ù… package-lock.json Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª..."
            npm ci
          else
            echo "(package-lock.json ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… npm install"
            npm install
          fi

      - name: ðŸ§± Ø¨Ù†Ø§Ø¡ Ø£ØµÙˆÙ„ Ø§Ù„ÙˆÙŠØ¨
        run: |
          echo "ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆÙŠØ¨..."
          npm run build --if-present
          WEBDIR="${{ github.event.inputs.web_dir }}"
          echo "Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡: $WEBDIR"
          ls -la "$WEBDIR" || echo "Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ÙØ§Ø±Øº"

      - name: ðŸ”Œ ØªØ«Ø¨ÙŠØª Capacitor CLI Ùˆ Core
        run: |
          npm install --no-save @capacitor/cli @capacitor/core

      - name: ðŸ“ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù capacitor.config.json ÙˆØªØ­Ø¯ÙŠØ« webDir
        run: |
          WEBDIR="${{ github.event.inputs.web_dir }}"
          if [ -f capacitor.config.json ]; then
            echo "capacitor.config.json Ù…ÙˆØ¬ÙˆØ¯ØŒ ØªØ­Ø¯ÙŠØ« webDir Ø¥Ù„Ù‰ $WEBDIR"
            node -e "
              const fs = require('fs');
              let config = JSON.parse(fs.readFileSync('capacitor.config.json', 'utf8'));
              config.webDir = '$WEBDIR';
              fs.writeFileSync('capacitor.config.json', JSON.stringify(config, null, 2));
            "
          else
            echo "Ø¥Ù†Ø´Ø§Ø¡ capacitor.config.json Ù…Ø¹ webDir=$WEBDIR"
            cat > capacitor.config.json <<EOF
          {
            "appId": "com.example.app",
            "appName": "ReactApp",
            "webDir": "$WEBDIR",
            "bundledWebRuntime": false,
            "server": {
              "androidScheme": "https"
            }
          }
          EOF
          fi
          cat capacitor.config.json

      - name: ðŸ“± Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù†ØµØ© Android
        run: |
          if [ -d "android" ]; then
            echo "Ù…Ù†ØµØ© Android Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„"
          else
            echo "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ© Android..."
            npx cap add android
          fi

      - name: ðŸ” Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ÙˆÙ†Ø³Ø® Ø§Ù„Ø£ØµÙˆÙ„
        run: |
          echo "Ù…Ø²Ø§Ù…Ù†Ø© ØªØ¨Ø¹ÙŠØ§Øª Capacitor..."
          npx cap sync android # ØªØ­Ø³ÙŠÙ†: Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø³Ø® [[30]]
          echo "Ù†Ø³Ø® Ø£ØµÙˆÙ„ Ø§Ù„ÙˆÙŠØ¨ Ø¥Ù„Ù‰ Android..."
          npx cap copy android --build

      - name: â˜• ØªÙ‡ÙŠØ¦Ø© Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'gradle' # ØªØ­Ø³ÙŠÙ†: Ø§Ø³ØªØ®Ø¯Ø§Ù… cache ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù€ Gradle [[20]]

      - name: ðŸ“± ØªÙ‡ÙŠØ¦Ø© Android SDK
        uses: android-actions/setup-android@v4
        with:
          api-level: 33
          build-tools: '33.0.2'

      - name: ðŸ”§ Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù€ gradlew
        working-directory: android
        run: chmod +x ./gradlew

      - name: ðŸ—ï¸ Ø¨Ù†Ø§Ø¡ APK (Ù†ÙˆØ¹: ${{ github.event.inputs.build_type }})
        working-directory: android
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type }}"
          if [ "$BUILD_TYPE" = "both" ]; then
            echo "Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø® debug Ùˆ release..."
            ./gradlew clean assembleDebug assembleRelease --build-cache
          elif [ "$BUILD_TYPE" = "debug" ]; then
            echo "Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø®Ø© debug ÙÙ‚Ø·..."
            ./gradlew clean assembleDebug --build-cache
          else
            echo "Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø®Ø© release ÙÙ‚Ø· (ØºÙŠØ± Ù…ÙˆÙ‚Ø¹)..."
            ./gradlew clean assembleRelease --build-cache
          fi
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2048m -Dorg.gradle.daemon=false --build-cache" # ØªØ­Ø³ÙŠÙ†: Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØªØ¹Ø·ÙŠÙ„ daemon Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª

      - name: ðŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¨Ù†ÙŠØ©
        working-directory: android
        run: |
          echo "Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¨Ù†ÙŠØ©:"
          find . -type f \( -name "*.apk" -o -name "*.aab" \) -exec ls -lh {} \;

      - name: ðŸ“¤ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª APK/AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts-${{ github.event.inputs.build_type }}
          path: |
            android/app/build/outputs/**/*.apk
            android/app/build/outputs/**/*.aab
          if-no-files-found: error
          retention-days: 90

      - name: ðŸ“Š Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†Ø§Ø¡
        run: |
          echo "Ø§ÙƒØªÙ…Ù„ Ø¨Ù†Ø§Ø¡ APK."
          echo "Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡: ${{ github.event.inputs.build_type }}"
          echo "Ù…Ø¬Ù„Ø¯ Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${{ github.event.inputs.web_dir }}"
